#!/bin/bash

# This script will read default-config.mk and generates config.mk and config.h
# config.mk is included in the Makefile script and config.h is included in all
# kernel code.

. default-config.mk

function exit_with_error(){
    echo "Error:" $1
    rm -f config.h
    rm -f config.mk
    exit 1
}
# Create kernel/config.h
rm -f ./kernel/config.h
touch ./kernel/config.h
echo "// Automatically created by the configure script" >> ./kernel/config.h
echo "#ifndef _KERNE_CONFIG_H" >> ./kernel/config.h
echo "#define _KERNE_CONFIG_H" >> ./kernel/config.h

# Create config.mk
rm -f config.mk
touch config.mk

# Copy some variables from default-config.mk to config.mk
echo "# Automatically created by the configure script" >> config.mk
echo "CFLAGS=-I./ $CFLAGS" >> config.mk
echo "LFLAGS=$LFLAGS" >> config.mk

# Specify the platform-specific macros
case $TARGET_PLAT in
    "RASPBERRYPI_ZERO"| "RASPBERRYPI_A" | "RASPBERRYPI_B")
        echo "TOOLCHAIN_PREFIX=arm-none-eabi-" >> config.mk
        echo "PLATDIR=platform/arm1176jzf-s/" >> config.mk
        echo "CFLAGS+=-mcpu=arm1176jzf-s -I./platform/arm1176jzf-s/" >> config.mk
        
        echo "#define ARCH_ARM32" >> ./kernel/config.h
        echo "#define PLAT_ARM1176JZF_S" >> ./kernel/config.h
        echo "#define PLAT_BCM2835" >> ./kernel/config.h
        ;;
    "RASPBERRYPI_TWO")
        echo "TOOLCHAIN_PREFIX=arm-none-eabi-" >> config.mk
        echo "PLATDIR=platform/arm-cortex-a7/" >> config.mk
        echo "CFLAGS+=-mcpu=cortex-a7 -I./platform/arm-cortex-a7/" >> config.mk

        echo "#define ARCH_ARM32" >> ./kernel/config.h
        echo "#define PLAT_ARMCORTEX_A7" >> ./kernel/config.h
        echo "#define PLAT_BCM2836" >> ./kernel/config.h
        ;;
    "X86_GENERIC")
        echo "TOOLCHAIN_PREFIX=" >> config.mk
        echo "PLATDIR=platform/x86/" >> config.mk
        echo "CFLAGS+=-m32" >> config.mk

        echo "#define PLAT_X86" >> ./kernel/config.h
        ;;
    "X86_64_GENERIC")
        echo "TOOLCHAIN_PREFIX=" >> config.mk
        echo "PLATDIR=platform/x86_64/" >> config.mk
        
        echo "#define PLAT_X86_64" >> ./kernel/config.h
        ;;
    *)
        exit_with_error "Invalid TARGET_PLAT selected in default-config.mk"
        ;;
esac

# Close config.h
echo "#endif //_KERNE_CONFIG_H" >> ./kernel/config.h

 
